<script>
    const NET_PER_KWH = 0.0643857;
    const CAP_PER_KW_YEAR = 56.2987;
    const DATA_YEAR = 18.56;
    const BTW = 0.06;
    const fmt = new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' });
    const fmtUnit = new Intl.NumberFormat('nl-BE', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    const THEME_KEY = 'energy-theme-v2';

    function parseDays(fromStr, toStr) {
      if (!fromStr || !toStr) return 0;
      const from = new Date(fromStr + 'T00:00:00');
      const to = new Date(toStr + 'T00:00:00');
      const ms = to.getTime() - from.getTime();
      return ms >= 0 ? Math.ceil(ms / 86400000) + 1 : 0;
    }

    // --- NIEUWE FUNCTIE ---
    // Berekent het aantal unieke maanden dat de periode omspant
    function parseMonths(fromStr, toStr) {
        if (!fromStr || !toStr) return 0;
        const from = new Date(fromStr + 'T00:00:00');
        const to = new Date(toStr + 'T00:00:00');
        if (to < from) return 0;

        const months = (to.getFullYear() - from.getFullYear()) * 12;
        return months - from.getMonth() + to.getMonth() + 1;
    }

    function calc() {
      const kwh = parseFloat(document.getElementById('kwh').value || '0');
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const days = parseDays(dateFrom, dateTo);
      // --- GEBRUIK DE NIEUWE FUNCTIE ---
      const months = parseMonths(dateFrom, dateTo);
      
      const price = parseFloat(document.getElementById('energyPrice').value || '0');
      const peakKwEl = document.getElementById('peakKw');
      const peakKw = peakKwEl && peakKwEl.value ? parseFloat(peakKwEl.value) : 11;
      const vatMode = document.querySelector('input[name="vatMode"]:checked')?.value || 'excl';

      if (!kwh || !days) {
        ['netCost', 'capCost', 'dataCost', 'energyIncl', 'total', 'unitPrice'].forEach(id => document.getElementById(id).textContent = '—');
        return;
      }
      
      // --- AANGEPASTE BEREKENING VOOR CAPACITEIT EN DATA ---
      const netExcl = kwh * (NET_PER_KWH / (1 + BTW));
      // Bereken capaciteitstarief op basis van aantal maanden
      const capExcl = (months / 12) * (peakKw * (CAP_PER_KW_YEAR / (1 + BTW)));
      // Bereken databeheer op basis van aantal maanden
      const dataExcl = (months / 12) * (DATA_YEAR / (1 + BTW));
      const energyExcl = kwh * (vatMode === 'incl' ? (price / (1 + BTW)) : price);
      
      const subTotalExcl = netExcl + capExcl + dataExcl + energyExcl;

      const netIncl = netExcl * (1 + BTW);
      const capIncl = capExcl * (1 + BTW);
      const dataIncl = dataExcl * (1 + BTW);
      const energyIncl = energyExcl * (1 + BTW);
      const total = subTotalExcl * (1 + BTW);

      const unitAllIn = kwh > 0 ? total / kwh : 0;
      
      document.getElementById('netCost').textContent = fmt.format(netIncl);
      document.getElementById('capCost').textContent = fmt.format(capIncl);
      document.getElementById('dataCost').textContent = fmt.format(dataIncl);
      document.getElementById('energyIncl').textContent = fmt.format(energyIncl);
      document.getElementById('total').textContent = fmt.format(total);
      document.getElementById('unitPrice').textContent = `${fmt.format(unitAllIn)} per kWh (${fmtUnit.format(unitAllIn)} €/kWh) — periode: ${days} dag(en), ${months} maand(en)`;
    }

    function setTheme(mode) {
      const body = document.body;
      const meta = document.getElementById('meta-theme');
      if (mode === 'dark') {
        body.classList.add('theme-dark');
        localStorage.setItem(THEME_KEY, 'dark');
        meta.setAttribute('content', '#0b1220');
      } else {
        body.classList.remove('theme-dark');
        localStorage.setItem(THEME_KEY, 'light');
        meta.setAttribute('content', '#f6f7fb');
      }
    }

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved) return setTheme(saved);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(prefersDark ? 'dark' : 'light');
    }

    window.addEventListener('DOMContentLoaded', () => {
      initTheme();

      const today = new Date();
      const dateToEl = document.getElementById('dateTo');
      const dateFromEl = document.getElementById('dateFrom');

      dateToEl.value = today.toISOString().slice(0, 10);
      dateFromEl.value = `${today.getFullYear()}-01-01`;
      
      calc();

      document.getElementById('calcBtn').addEventListener('click', calc);
      document.querySelectorAll('input').forEach(el => el.addEventListener('input', calc));
      document.getElementById('pdfBtn').addEventListener('click', () => window.print());
      document.getElementById('themeBtn').addEventListener('click', () => {
        const now = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
        setTheme(now);
      });
    });
  </script>
